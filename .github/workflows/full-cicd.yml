name: Full CI/CD Pipeline

on:
  push:
    branches: ["main", "master", "work"]
  pull_request:
  workflow_dispatch:
    inputs:
      terraform_apply:
        description: "Apply Terraform changes"
        required: false
        default: "false"

permissions:
  contents: read
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/devops-learning-frontend
  BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/devops-learning-backend
  HELM_RELEASE: devops-learning
  HELM_NAMESPACE: prod

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Frontend/backend checks
        run: |
          node --check js/main.js
          node --check js/renderers.js
          node --check js/ui.js
          node --check js/api.js
          node --check js/ai.js
          node --check backend/server.js
      - name: Content and docs checks
        run: |
          python3 -m json.tool data/content.json >/dev/null
          python3 scripts/content_change_watcher.py

  build-and-push:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.frontend
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
            ${{ env.FRONTEND_IMAGE }}:latest
      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.backend
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
            ${{ env.BACKEND_IMAGE }}:latest

  terraform:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name != 'pull_request'
    defaults:
      run:
        working-directory: infra/terraform/environments/prod
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Terraform Init
        run: terraform init
      - name: Terraform Format Check
        run: terraform fmt -check -recursive
      - name: Terraform Validate
        run: terraform validate
      - name: Terraform Plan
        run: terraform plan -input=false -out=tfplan
      - name: Terraform Apply (manual input on workflow_dispatch)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.terraform_apply == 'true'
        run: terraform apply -input=false -auto-approve tfplan

  helm-deploy:
    runs-on: ubuntu-latest
    needs: [build-and-push, terraform]
    if: github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Helm
        uses: azure/setup-helm@v4
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${KUBE_CONFIG_DATA}" | base64 -d > ~/.kube/config
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      - name: Deploy with Helm
        run: |
          helm upgrade --install $HELM_RELEASE helm/devops-learning \
            --namespace $HELM_NAMESPACE \
            --create-namespace \
            -f helm/devops-learning/values-prod.yaml \
            --set global.namespace=${HELM_NAMESPACE} \
            --set frontend.image.repository=${FRONTEND_IMAGE} \
            --set frontend.image.tag=${GITHUB_SHA} \
            --set backend.image.repository=${BACKEND_IMAGE} \
            --set backend.image.tag=${GITHUB_SHA}

  notify-failure:
    runs-on: ubuntu-latest
    needs: [test, build-and-push, terraform, helm-deploy]
    if: failure()
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not set; skipping notification."
            exit 0
          fi
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"‚ùå DevOps Learning Platform CI/CD failed on '${{ github.ref_name }}'. Check workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
            "$SLACK_WEBHOOK_URL"
